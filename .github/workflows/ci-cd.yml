name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: 3.9
  DOCKER_BUILDKIT: 1

jobs:
  # Code Quality Checks
  lint-and-format:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black isort flake8 mypy
        pip install -r requirements.txt
    
    - name: Code formatting check with Black
      run: black --check --diff src/ tests/
    
    - name: Import sorting check with isort
      run: isort --check-only --diff src/ tests/
    
    - name: Lint with flake8
      run: |
        flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Type checking with mypy
      run: mypy src/ --ignore-missing-imports
      continue-on-error: true

  # Unit Tests
  unit-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-mock
        pip install -r requirements.txt
    
    - name: Run unit tests
      run: |
        pytest tests/test_producer.py tests/test_processor.py -v --cov=src --cov-report=xml
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # Docker Build and Test
  docker-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker images
      run: |
        docker compose build
    
    - name: Start services
      run: |
        docker compose up -d
        
    - name: Wait for services to be ready
      run: |
        echo "Waiting for services to start..."
        sleep 30
        
        # Check if services are running
        docker compose ps
        
        # Test MongoDB connection
        timeout 30 bash -c 'until docker compose exec -T mongodb mongosh --eval "db.adminCommand(\"ping\")" > /dev/null 2>&1; do sleep 1; done'
        
        # Test Kafka connection
        timeout 30 bash -c 'until docker compose exec -T kafka kafka-topics --list --bootstrap-server kafka:9092 > /dev/null 2>&1; do sleep 1; done'
    
    - name: Run integration tests
      run: |
        python -m pip install --upgrade pip
        pip install pytest requests pandas
        pytest tests/test_integration.py -v -k "not test_producer_to_kafka_flow"
    
    - name: Test pipeline components
      run: |
        # Test producer
        docker compose exec -T app python src/producer.py
        
        # Test processor
        timeout 30 docker compose exec -T app python src/test_processor.py || true
        
        # Check if data was processed
        docker compose exec -T app python -c "
from pymongo import MongoClient
try:
    client = MongoClient('mongodb://admin:password@mongodb:27017/')
    db = client['retail_db']
    count = db.transactions.count_documents({})
    print(f'Total documents in MongoDB: {count}')
    client.close()
except Exception as e:
    print(f'MongoDB connection error: {e}')
    exit(1)
"
    
    - name: Cleanup
      run: |
        docker compose down -v
      if: always()

  # Security Scans
  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit
        pip install -r requirements.txt
    
    - name: Run safety check for known vulnerabilities
      run: safety check --json
      continue-on-error: true
    
    - name: Run bandit security linter
      run: bandit -r src/ -f json
      continue-on-error: true
    
    - name: Docker security scan
      uses: docker/scout-action@v1
      with:
        command: cves
        image: retail-pipeline-app:latest
      continue-on-error: true

  # Performance Tests
  performance:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-benchmark
        pip install -r requirements.txt
    
    - name: Run performance tests
      run: |
        pytest tests/test_integration.py::TestPerformance -v

  # Build and Push Docker Images (on main branch)
  deploy:
    needs: [lint-and-format, unit-tests, docker-tests, security]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
      if: env.DOCKER_USERNAME && env.DOCKER_PASSWORD
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/retail-pipeline:latest
          ${{ secrets.DOCKER_USERNAME }}/retail-pipeline:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
      if: env.DOCKER_USERNAME && env.DOCKER_PASSWORD
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Deploy notification
      run: |
        echo "üöÄ Deployment completed successfully!"
        echo "Docker image: ${{ secrets.DOCKER_USERNAME }}/retail-pipeline:${{ github.sha }}"

  # Notification
  notify:
    needs: [deploy]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: Notify on success
      if: needs.deploy.result == 'success'
      run: |
        echo "‚úÖ Pipeline completed successfully!"
        
    - name: Notify on failure  
      if: needs.deploy.result == 'failure'
      run: |
        echo "‚ùå Pipeline failed!"
        exit 1